Index: serf.mak
===================================================================
--- serf.mak	(revision 1624)
+++ serf.mak	(working copy)
@@ -40,16 +42,32 @@
 !ENDIF
 
 ########
+# Use static APR and APR-Util
+
+!IFDEF APR_STATIC
+CFLAGS = $(CFLAGS) /DAPR_DECLARE_STATIC /DAPU_DECLARE_STATIC
+APR_LIBNAME = apr
+!IF "$(DEBUG_BUILD)" == ""
+APR_INTDIR = LibR
+!ELSE
+APR_INTDIR = LibD
+!ENDIF
+!ELSE
+APR_LIBNAME = libapr
+APR_INTDIR = $(INTDIR)
+!ENDIF
+
+########
 # APR
 !IF "$(APR_SRC)" == ""
 !ERROR APR is required. Please define APR_SRC or HTTPD_SRC.
 !ENDIF
 
 APR_FLAGS = /I "$(APR_SRC)\include"
-!IF [IF EXIST "$(APR_SRC)\$(INTDIR)\libapr-1.lib" exit 1] == 1
-APR_LIBS = "$(APR_SRC)\$(INTDIR)\libapr-1.lib"
+!IF [IF EXIST "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)-1.lib" exit 1] == 1
+APR_LIBS = "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)-1.lib"
 !ELSE
-APR_LIBS = "$(APR_SRC)\$(INTDIR)\libapr.lib"
+APR_LIBS = "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME).lib"
 !ENDIF
 
 ########
@@ -59,10 +77,10 @@
 !ENDIF
 
 APRUTIL_FLAGS = /I "$(APRUTIL_SRC)\include"
-!IF [IF EXIST "$(APRUTIL_SRC)\$(INTDIR)\libaprutil-1.lib" exit 1] == 1
-APRUTIL_LIBS = "$(APRUTIL_SRC)\$(INTDIR)\libaprutil-1.lib"
+!IF [IF EXIST "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util-1.lib" exit 1] == 1
+APRUTIL_LIBS = "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util-1.lib"
 !ELSE
-APRUTIL_LIBS = "$(APRUTIL_SRC)\$(INTDIR)\libaprutil.lib"
+APRUTIL_LIBS = "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util.lib"
 !ENDIF
 
 ########

@@ -148,6 +165,16 @@
     "$(INTDIR)\test_server.obj" \
 
 TEST_LIBS = user32.lib advapi32.lib gdi32.lib ws2_32.lib
+
+!IFDEF APR_STATIC
+TEST_LIBS = $(TEST_LIBS) mswsock.lib rpcrt4.lib shell32.lib
+!ENDIF
+
+!IF "$(DEBUG_BUILD)" == ""
+TEST_LIBS = $(TEST_LIBS) msvcrt.lib
+!ELSE
+TEST_LIBS = $(TEST_LIBS) msvcrtd.lib
+!ENDIF
 
 
 ALL: INTDIR $(STATIC_LIB) TESTS
