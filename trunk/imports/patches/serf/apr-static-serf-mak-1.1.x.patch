Index: serf.mak
===================================================================
--- serf.mak	(revision 1624)
+++ serf.mak	(working copy)
@@ -9,6 +9,7 @@
 !ENDIF
 
 CFLAGS = /Zi /W3 /EHsc /I "./"
+LIB32_FLAGS = /nologo
 
 !IF "$(DEBUG_BUILD)" == ""
 INTDIR = Release
@@ -18,6 +19,7 @@
 INTDIR = Debug
 CFLAGS = /MDd /Od /W3 /Gm /D "_DEBUG" $(CFLAGS)
 STATIC_LIB = $(INTDIR)\serf-1.lib
+LIB32_FLAGS = $(LIB32_FLAGS) /NODEFAULTLIB:msvcrt.lib
 !ENDIF
 
 ########
@@ -40,16 +42,32 @@
 !ENDIF
 
 ########
+# Use static APR and APR-Util
+
+!IFDEF APR_STATIC
+CFLAGS = $(CFLAGS) /DAPR_DECLARE_STATIC /DAPU_DECLARE_STATIC
+APR_LIBNAME = apr
+!IF "$(DEBUG_BUILD)" == ""
+APR_INTDIR = LibR
+!ELSE
+APR_INTDIR = LibD
+!ENDIF
+!ELSE
+APR_LIBNAME = libapr
+APR_INTDIR = $(INTDIR)
+!ENDIF
+
+########
 # APR
 !IF "$(APR_SRC)" == ""
 !ERROR APR is required. Please define APR_SRC or HTTPD_SRC.
 !ENDIF
 
 APR_FLAGS = /I "$(APR_SRC)\include"
-!IF [IF EXIST "$(APR_SRC)\$(INTDIR)\libapr-1.lib" exit 1] == 1
-APR_LIBS = "$(APR_SRC)\$(INTDIR)\libapr-1.lib"
+!IF [IF EXIST "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)-1.lib" exit 1] == 1
+APR_LIBS = "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)-1.lib"
 !ELSE
-APR_LIBS = "$(APR_SRC)\$(INTDIR)\libapr.lib"
+APR_LIBS = "$(APR_SRC)\$(APR_INTDIR)\$(APR_LIBNAME).lib"
 !ENDIF
 
 ########
@@ -59,10 +77,10 @@
 !ENDIF
 
 APRUTIL_FLAGS = /I "$(APRUTIL_SRC)\include"
-!IF [IF EXIST "$(APRUTIL_SRC)\$(INTDIR)\libaprutil-1.lib" exit 1] == 1
-APRUTIL_LIBS = "$(APRUTIL_SRC)\$(INTDIR)\libaprutil-1.lib"
+!IF [IF EXIST "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util-1.lib" exit 1] == 1
+APRUTIL_LIBS = "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util-1.lib"
 !ELSE
-APRUTIL_LIBS = "$(APRUTIL_SRC)\$(INTDIR)\libaprutil.lib"
+APRUTIL_LIBS = "$(APRUTIL_SRC)\$(APR_INTDIR)\$(APR_LIBNAME)util.lib"
 !ENDIF
 
 ########
@@ -95,7 +113,6 @@
 CPP=cl.exe
 CPP_PROJ = /c /nologo $(CFLAGS) $(WIN32_DEFS) $(APR_FLAGS) $(APRUTIL_FLAGS) $(OPENSSL_FLAGS) $(ZLIB_FLAGS) /Fo"$(INTDIR)\\" /Fd"$(INTDIR)\\"
 LIB32=link.exe
-LIB32_FLAGS=/nologo
 
 LIB32_OBJS= \
     "$(INTDIR)\aggregate_buckets.obj" \
@@ -148,6 +165,11 @@
     "$(INTDIR)\test_server.obj" \
 
 TEST_LIBS = user32.lib advapi32.lib gdi32.lib ws2_32.lib
+!IFDEF APR_STATIC
+TEST_LIBS = $(TEST_LIBS) mswsock.lib rpcrt4.lib shell32.lib msvcrt.lib
+!ELSE
+TEST_LIBS = $(TEST_LIBS) msvcrt.lib
+!ENDIF
 
 
 ALL: INTDIR $(STATIC_LIB) TESTS
